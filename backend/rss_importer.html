<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDC Blog - Complete Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 0;
            min-height: 600px;
        }

        /* Left Panel - Forms */
        .left-panel {
            padding: 30px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
        }

        /* Right Panel - Blog Display */
        .right-panel {
            padding: 30px;
            background: white;
            overflow-y: auto;
            max-height: 800px;
        }

        /* Form Styles */
        .form-section {
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-section h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Status Messages */
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* User Info */
        .user-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .user-info h4 {
            color: #2d5a2d;
            margin-bottom: 10px;
        }

        .user-info p {
            color: #4a6741;
            margin: 5px 0;
        }

        /* Blog Display */
        .blog-container {
            margin-bottom: 30px;
        }

        .blog-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .blog-card:hover {
            transform: translateY(-2px);
        }

        .blog-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .blog-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .blog-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .blog-domain {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .blog-content {
            line-height: 1.6;
            color: #444;
        }

        /* Style the HTML content properly */
        .blog-content h1, .blog-content h2, .blog-content h3,
        .blog-content h4, .blog-content h5, .blog-content h6 {
            margin: 20px 0 15px 0;
            color: #333;
        }

        .blog-content p {
            margin-bottom: 15px;
        }

        .blog-content ul, .blog-content ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        .blog-content li {
            margin-bottom: 8px;
        }

        .blog-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 20px;
            margin: 20px 0;
            font-style: italic;
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
        }

        .blog-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .blog-content pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
        }

        .blog-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 15px 0;
        }

        .blog-content a {
            color: #667eea;
            text-decoration: none;
        }

        .blog-content a:hover {
            text-decoration: underline;
        }

        .blog-link {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .blog-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .blog-link a:hover {
            text-decoration: underline;
        }

        /* Domain Statistics */
        .domain-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .domain-stats h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .domain-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .domain-item:last-child {
            border-bottom: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .blog-meta {
                flex-direction: column;
                gap: 10px;
            }
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 DDC Blog Complete Demo</h1>
            <p>Register → Import RSS → View Blogs | Full API Demonstration</p>
        </div>

        <div class="main-content">
            <!-- Left Panel: Forms -->
            <div class="left-panel">
                <!-- User Registration -->
                <div class="form-section" id="registrationSection">
                    <h3>👤 Step 1: User Registration</h3>
                    <form id="registrationForm">
                        <div class="form-group">
                            <label for="username">Username:</label>
                            <input type="text" id="username" name="username" required placeholder="johndoe">
                        </div>
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" name="email" required placeholder="john@example.com">
                        </div>
                        <div class="form-group">
                            <label for="password">Password:</label>
                            <input type="password" id="password" name="password" required placeholder="Enter password">
                        </div>
                        <div class="form-group">
                            <label for="passwordConfirm">Confirm Password:</label>
                            <input type="password" id="passwordConfirm" name="passwordConfirm" required placeholder="Confirm password">
                        </div>
                        <div class="form-group">
                            <label for="firstName">First Name:</label>
                            <input type="text" id="firstName" name="first_name" placeholder="John">
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name:</label>
                            <input type="text" id="lastName" name="last_name" placeholder="Doe">
                        </div>
                        <div class="form-group">
                            <label for="bio">Bio:</label>
                            <textarea id="bio" name="bio" rows="3" placeholder="Tell us about yourself..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="preferredDomains">Preferred Domains (comma-separated):</label>
                            <input type="text" id="preferredDomains" name="preferred_domains" placeholder="Technology, Programming, AI">
                        </div>
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="canImportRss" name="can_import_rss" checked>
                                <label for="canImportRss">Can Import RSS Feeds</label>
                            </div>
                        </div>
                        <button type="submit" class="btn">Register User</button>
                    </form>
                    <div style="text-align: center; margin-top: 15px;">
                        <p style="color: #666;">Already have an account?</p>
                        <button type="button" class="btn" id="showLoginBtn" style="background: #6c757d; margin-top: 5px;">Login Instead</button>
                    </div>
                </div>

                <!-- User Login (Alternative to Registration) -->
                <div class="form-section hidden" id="loginSection">
                    <h3>🔑 Step 1: User Login</h3>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="loginUsername">Username:</label>
                            <input type="text" id="loginUsername" name="username" required placeholder="johndoe">
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password:</label>
                            <input type="password" id="loginPassword" name="password" required placeholder="Enter password">
                        </div>
                        <button type="submit" class="btn">Login</button>
                    </form>
                    <div style="text-align: center; margin-top: 15px;">
                        <p style="color: #666;">Don't have an account?</p>
                        <button type="button" class="btn" id="showRegisterBtn" style="background: #6c757d; margin-top: 5px;">Register Instead</button>
                    </div>
                </div>

                <!-- User Info (shown after registration/login) -->
                <div class="user-info hidden" id="userInfo">
                    <h4>🎉 Authentication Successful!</h4>
                    <p><strong>Username:</strong> <span id="displayUsername"></span></p>
                    <p><strong>Email:</strong> <span id="displayEmail"></span></p>
                    <p><strong>Can Import RSS:</strong> <span id="displayCanImport"></span></p>
                    <p><strong>Token:</strong> <span id="displayToken" style="font-family: monospace; font-size: 12px;"></span></p>
                </div>

                <!-- RSS Import -->
                <div class="form-section hidden" id="rssSection">
                    <h3>📡 Step 2: Import RSS Feed</h3>
                    <form id="rssForm">
                        <div class="form-group">
                            <label for="rssUrl">RSS Feed URL:</label>
                            <input type="url" id="rssUrl" name="rss_url" required 
                                   placeholder="https://medium.com/feed/@username">
                        </div>
                        <div class="form-group">
                            <label for="domain">Domain/Category:</label>
                            <input type="text" id="domain" name="domain" required 
                                   placeholder="Technology" value="Technology">
                        </div>
                        <button type="submit" class="btn">Import RSS Feed</button>
                    </form>
                    <button type="button" class="btn" id="syncAllBtn" style="background: #28a745;">🔄 Sync All Feeds</button>
                </div>

                <!-- Domain Statistics -->
                <div class="domain-stats hidden" id="domainStats">
                    <h4>📊 Domain Statistics</h4>
                    <div id="domainList"></div>
                </div>
            </div>

            <!-- Right Panel: Blog Display -->
            <div class="right-panel">
                <div id="statusMessages"></div>
                
                <!-- Authentication Status -->
                <div id="authStatus" style="margin-bottom: 20px;"></div>
                
                <!-- Domain Statistics (shown when forms are hidden) -->
                <div class="domain-stats hidden" id="domainStatsMain">
                    <h4>📊 Domain Statistics</h4>
                    <div id="domainListMain"></div>
                </div>

                <!-- API Testing Section -->
                <div class="form-section hidden" id="apiTestingSection">
                    <h3>🧪 API Endpoint Testing</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button type="button" class="btn" id="testDomainsBtn" style="background: #6f42c1;">GET /domains/</button>
                        <button type="button" class="btn" id="testProjectsBtn" style="background: #6f42c1;">GET /projects/</button>
                        <button type="button" class="btn" id="testProjectsByDomainBtn" style="background: #6f42c1;">GET /projects/{domain}/</button>
                        <button type="button" class="btn" id="testSpecificProjectBtn" style="background: #6f42c1;">GET /projects/{domain}/{id}/</button>
                        <button type="button" class="btn" id="testLogoutBtn" style="background: #dc3545;">POST /logout/</button>
                        <button type="button" class="btn" id="testBlogCRUDBtn" style="background: #fd7e14;">Test Blog CRUD</button>
                    </div>
                    <div id="apiTestResults" style="margin-top: 15px; max-height: 300px; overflow-y: auto;"></div>
                </div>
                
                <div class="blog-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>📰 Imported Blogs</h3>
                        <div>
                            <button type="button" class="btn" id="toggleApiTestBtn" style="width: auto; background: #6f42c1; margin-right: 10px;">🧪 API Tests</button>
                            <button type="button" class="btn" id="showFormsBtn" style="width: auto; background: #6c757d; margin-right: 10px;">📝 Show Forms</button>
                            <button type="button" class="btn" id="refreshBlogsBtn" style="width: auto; background: #17a2b8;">🔄 Refresh Blogs</button>
                        </div>
                    </div>
                    <div id="blogList">
                        <div class="loading">Complete registration and RSS import to see blogs here...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentUser = null;
        let authToken = null;

        // Authentication state management
        function saveAuthState(user, token) {
            currentUser = user;
            authToken = token;
            localStorage.setItem('currentUser', JSON.stringify(user));
            localStorage.setItem('authToken', token);
            updateAuthDisplay();
        }

        function loadAuthState() {
            const savedUser = localStorage.getItem('currentUser');
            const savedToken = localStorage.getItem('authToken');
            
            if (savedUser && savedToken) {
                currentUser = JSON.parse(savedUser);
                authToken = savedToken;
                updateAuthDisplay();
                return true;
            }
            return false;
        }

        function clearAuthState() {
            currentUser = null;
            authToken = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('authToken');
            updateAuthDisplay();
        }

        function updateAuthDisplay() {
            const authStatus = document.getElementById('authStatus');
            if (currentUser && authToken) {
                authStatus.innerHTML = `
                    <div class="status success">
                        🔐 Authenticated as: <strong>${currentUser.username}</strong> 
                        <button onclick="clearAuthState()" style="margin-left: 10px; padding: 2px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">Clear Auth</button>
                    </div>
                `;
            } else {
                authStatus.innerHTML = `
                    <div class="status error">
                        ❌ Not authenticated - Please register or login first
                    </div>
                `;
            }
        }

        // Utility Functions
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessages');
            const statusElement = document.createElement('div');
            statusElement.className = `status ${type}`;
            statusElement.textContent = message;
            statusDiv.appendChild(statusElement);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                statusElement.remove();
            }, 5000);
        }

        function makeAuthenticatedRequest(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (authToken) {
                headers['Authorization'] = `Token ${authToken}`;
                console.log('Using auth token:', authToken.substring(0, 10) + '...');
            } else {
                console.warn('No auth token available for request to:', url);
            }
            
            return fetch(url, { ...options, headers });
        }

        // Toggle between registration and login forms
        document.getElementById('showLoginBtn').addEventListener('click', () => {
            document.getElementById('registrationSection').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
        });

        document.getElementById('showRegisterBtn').addEventListener('click', () => {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('registrationSection').classList.remove('hidden');
        });

        // Function to handle successful authentication (registration or login)
        function handleSuccessfulAuth(data, isRegistration = false) {
            console.log('Authentication successful:', data); // Debug log
            
            // Save authentication state
            saveAuthState(data.user, data.token);
            
            // Display user info
            document.getElementById('displayUsername').textContent = data.user.username;
            document.getElementById('displayEmail').textContent = data.user.email;
            document.getElementById('displayCanImport').textContent = data.user.can_import_rss ? 'Yes' : 'No';
            document.getElementById('displayToken').textContent = data.token.substring(0, 20) + '...';
            
            // Hide both auth forms and show user info
            document.getElementById('registrationSection').classList.add('hidden');
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('rssSection').classList.remove('hidden');
            
            const message = isRegistration ? 
                '✅ User registered successfully! Now import an RSS feed.' : 
                '✅ Login successful! Now import an RSS feed.';
            showStatus(message, 'success');
        }

        // Step 1: User Registration
        document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userData = {
                username: formData.get('username'),
                email: formData.get('email'),
                password: formData.get('password'),
                passwordConfirm: formData.get('passwordConfirm'),
                first_name: formData.get('first_name'),
                last_name: formData.get('last_name'),
                bio: formData.get('bio'),
                preferred_domains: formData.get('preferred_domains').split(',').map(d => d.trim()).filter(d => d),
                can_import_rss: formData.get('can_import_rss') === 'on'
            };

            try {
                showStatus('Registering user...', 'info');
                
                const response = await fetch(`${API_BASE}/register/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (response.ok) {
                    handleSuccessfulAuth(data, true);
                } else {
                    showStatus(`❌ Registration failed: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                showStatus(`❌ Registration error: ${error.message}`, 'error');
            }
        });

        // Step 1: User Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const loginData = {
                username: formData.get('username'),
                password: formData.get('password')
            };

            try {
                showStatus('Logging in...', 'info');
                
                const response = await fetch(`${API_BASE}/login/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(loginData)
                });

                const data = await response.json();

                if (response.ok) {
                    handleSuccessfulAuth(data, false);
                } else {
                    showStatus(`❌ Login failed: ${data.error || 'Invalid credentials'}`, 'error');
                }
            } catch (error) {
                showStatus(`❌ Login error: ${error.message}`, 'error');
            }
        });

        // Step 2: RSS Import
        document.getElementById('rssForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!authToken) {
                showStatus('❌ Please register first!', 'error');
                return;
            }

            const formData = new FormData(e.target);
            const rssData = {
                rss_url: formData.get('rss_url'),
                domain: formData.get('domain')
            };

            try {
                showStatus('🔄 Importing RSS feed...', 'info');
                
                const response = await makeAuthenticatedRequest(`${API_BASE}/import-rss/`, {
                    method: 'POST',
                    body: JSON.stringify(rssData)
                });

                const result = await response.json();
                console.log('RSS import result:', result); // Debug log

                if (response.ok && result.success) {
                    showStatus(`✅ RSS import successful! ${result.processed} blogs imported, ${result.skipped} skipped.`, 'success');
                    
                    // Show import details
                    if (result.blogs && result.blogs.length > 0) {
                        console.log('Newly imported blogs:', result.blogs); // Debug log
                    }
                    
                    // Hide forms and show full-width blog display
                    document.querySelector('.left-panel').style.display = 'none';
                    document.querySelector('.main-content').style.gridTemplateColumns = '1fr';
                    
                    // Load and display blogs with a small delay to ensure DB is updated
                    setTimeout(async () => {
                        await loadBlogs();
                        await loadDomainStats();
                    }, 1000);
                    
                    // Show domain stats in main area
                    document.getElementById('domainStatsMain').classList.remove('hidden');
                } else {
                    console.error('RSS import failed:', result); // Debug log
                    showStatus(`❌ RSS import failed: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus(`❌ RSS import error: ${error.message}`, 'error');
            }
        });

        // Sync All Feeds
        document.getElementById('syncAllBtn').addEventListener('click', async () => {
            if (!authToken) {
                showStatus('❌ Please register first!', 'error');
                return;
            }

            try {
                showStatus('🔄 Syncing all feeds...', 'info');
                
                const response = await makeAuthenticatedRequest(`${API_BASE}/sync-feeds/`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showStatus(`✅ Sync complete! ${result.total_new_blogs} new blogs added.`, 'success');
                    await loadBlogs();
                    await loadDomainStats();
                } else {
                    showStatus(`❌ Sync failed: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus(`❌ Sync error: ${error.message}`, 'error');
            }
        });

        // Load and Display Blogs
        async function loadBlogs() {
            try {
                console.log('Loading blogs...'); // Debug log
                showStatus('🔄 Loading blogs...', 'info');
                
                const response = await fetch(`${API_BASE}/blogs/`);
                const data = await response.json();
                
                console.log('Blog response:', response.status, data); // Debug log

                const blogList = document.getElementById('blogList');
                
                if (response.ok) {
                    // Handle both paginated and non-paginated responses
                    const blogs = data.results || data;
                    
                    if (blogs && blogs.length > 0) {
                        console.log(`Found ${blogs.length} blogs`); // Debug log
                        blogList.innerHTML = blogs.map(blog => `
                            <div class="blog-card">
                                <div class="blog-header">
                                    <h2 class="blog-title">${escapeHtml(blog.title)}</h2>
                                    <div class="blog-meta">
                                        <span>👤 ${escapeHtml(blog.writer)}</span>
                                        <span>📅 ${new Date(blog.created_at).toLocaleDateString()}</span>
                                        <span class="blog-domain">${escapeHtml(blog.domain)}</span>
                                    </div>
                                </div>
                                <div class="blog-content">
                                    ${blog.content}
                                </div>
                                ${blog.blog_link ? `
                                    <div class="blog-link">
                                        <a href="${blog.blog_link}" target="_blank">🔗 Read Original Article</a>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('');
                        showStatus(`✅ Loaded ${blogs.length} blogs successfully!`, 'success');
                    } else {
                        console.log('No blogs found in response'); // Debug log
                        blogList.innerHTML = '<div class="loading">No blogs found. Import an RSS feed to see blogs here.</div>';
                        showStatus('ℹ️ No blogs found in database.', 'info');
                    }
                } else {
                    console.error('Blog loading failed:', data); // Debug log
                    blogList.innerHTML = '<div class="loading">Error loading blogs. Please try again.</div>';
                    showStatus(`❌ Failed to load blogs: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Blog loading error:', error); // Debug log
                showStatus(`❌ Error loading blogs: ${error.message}`, 'error');
                document.getElementById('blogList').innerHTML = '<div class="loading">Error loading blogs. Please check console for details.</div>';
            }
        }

        // HTML escape function to prevent XSS
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Load Domain Statistics
        async function loadDomainStats() {
            try {
                const response = await fetch(`${API_BASE}/projects/`);
                const data = await response.json();

                const domainList = document.getElementById('domainList');
                const domainListMain = document.getElementById('domainListMain');
                
                if (data.domain_details && data.domain_details.length > 0) {
                    const domainHTML = data.domain_details.map(domain => `
                        <div class="domain-item">
                            <span>${domain.domain}</span>
                            <span><strong>${domain.count}</strong> blogs</span>
                        </div>
                    `).join('');
                    
                    // Update both domain stat locations
                    if (domainList) domainList.innerHTML = domainHTML;
                    if (domainListMain) domainListMain.innerHTML = domainHTML;
                } else {
                    const noDomainHTML = '<div class="domain-item">No domains found</div>';
                    if (domainList) domainList.innerHTML = noDomainHTML;
                    if (domainListMain) domainListMain.innerHTML = noDomainHTML;
                }
            } catch (error) {
                console.error('Error loading domain stats:', error);
            }
        }

        // Manual refresh blogs button
        document.getElementById('refreshBlogsBtn').addEventListener('click', async () => {
            await loadBlogs();
            await loadDomainStats();
        });

        // Show forms button (toggle back to forms view)
        document.getElementById('showFormsBtn').addEventListener('click', () => {
            document.querySelector('.left-panel').style.display = 'block';
            document.querySelector('.main-content').style.gridTemplateColumns = '1fr 2fr';
            showStatus('📝 Forms are now visible. You can import more RSS feeds or register new users.', 'info');
        });

        // Toggle API testing section
        document.getElementById('toggleApiTestBtn').addEventListener('click', () => {
            const testSection = document.getElementById('apiTestingSection');
            testSection.classList.toggle('hidden');
            const btn = document.getElementById('toggleApiTestBtn');
            btn.textContent = testSection.classList.contains('hidden') ? '🧪 API Tests' : '❌ Hide Tests';
        });

        // API Testing Functions
        function addTestResult(endpoint, method, status, data) {
            const testResults = document.getElementById('apiTestResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = status < 400 ? 'status success' : 'status error';
            resultDiv.innerHTML = `
                <strong>${method} ${endpoint}</strong><br>
                Status: ${status}<br>
                Response: <pre style="margin-top: 5px; background: #f8f9fa; padding: 5px; border-radius: 3px; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>
            `;
            testResults.appendChild(resultDiv);
            testResults.scrollTop = testResults.scrollHeight;
        }

        // Test GET /domains/
        document.getElementById('testDomainsBtn').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE}/domains/`);
                const data = await response.json();
                addTestResult('/domains/', 'GET', response.status, data);
            } catch (error) {
                addTestResult('/domains/', 'GET', 'ERROR', { error: error.message });
            }
        });

        // Test GET /projects/
        document.getElementById('testProjectsBtn').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE}/projects/`);
                const data = await response.json();
                addTestResult('/projects/', 'GET', response.status, data);
            } catch (error) {
                addTestResult('/projects/', 'GET', 'ERROR', { error: error.message });
            }
        });

        // Test GET /projects/{domain}/
        document.getElementById('testProjectsByDomainBtn').addEventListener('click', async () => {
            try {
                // Try with 'Technology' domain first, fallback to first available domain
                let domain = 'Technology';
                
                // Get available domains first
                const domainsResponse = await fetch(`${API_BASE}/projects/`);
                const domainsData = await domainsResponse.json();
                
                if (domainsData.domains && domainsData.domains.length > 0) {
                    domain = domainsData.domains[0];
                }
                
                const response = await fetch(`${API_BASE}/projects/${domain}/`);
                const data = await response.json();
                addTestResult(`/projects/${domain}/`, 'GET', response.status, data);
            } catch (error) {
                addTestResult('/projects/{domain}/', 'GET', 'ERROR', { error: error.message });
            }
        });

        // Test GET /projects/{domain}/{id}/
        document.getElementById('testSpecificProjectBtn').addEventListener('click', async () => {
            try {
                // Get first blog ID from /blogs/ endpoint
                const blogsResponse = await fetch(`${API_BASE}/blogs/`);
                const blogsData = await blogsResponse.json();
                
                const blogs = blogsData.results || blogsData;
                if (blogs && blogs.length > 0) {
                    const blog = blogs[0];
                    const response = await fetch(`${API_BASE}/projects/${blog.domain}/${blog.id}/`);
                    const data = await response.json();
                    addTestResult(`/projects/${blog.domain}/${blog.id}/`, 'GET', response.status, data);
                } else {
                    addTestResult('/projects/{domain}/{id}/', 'GET', 'ERROR', { error: 'No blogs found to test with' });
                }
            } catch (error) {
                addTestResult('/projects/{domain}/{id}/', 'GET', 'ERROR', { error: error.message });
            }
        });

        // Test POST /logout/
        document.getElementById('testLogoutBtn').addEventListener('click', async () => {
            console.log('Testing logout - Current auth token:', authToken ? authToken.substring(0, 10) + '...' : 'null');
            
            if (!authToken) {
                addTestResult('/logout/', 'POST', 'ERROR', { 
                    error: 'No auth token available',
                    solution: 'Please login first or check authentication state',
                    currentUser: currentUser,
                    tokenExists: !!authToken
                });
                return;
            }
            
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/logout/`, {
                    method: 'POST'
                });
                
                let data;
                try {
                    data = await response.json();
                } catch {
                    data = { message: 'No response body' };
                }
                
                addTestResult('/logout/', 'POST', response.status, data);
                
                if (response.ok) {
                    // Clear auth state after successful logout
                    clearAuthState();
                    showStatus('⚠️ Logged out! You\'ll need to login again to access protected endpoints.', 'info');
                } else {
                    showStatus(`❌ Logout failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                addTestResult('/logout/', 'POST', 'ERROR', { error: error.message });
            }
        });

        // Test Blog CRUD operations
        document.getElementById('testBlogCRUDBtn').addEventListener('click', async () => {
            console.log('Testing CRUD - Current auth token:', authToken ? authToken.substring(0, 10) + '...' : 'null');
            console.log('Current user:', currentUser);
            
            if (!authToken || !currentUser) {
                addTestResult('Blog CRUD', 'MULTIPLE', 'ERROR', { 
                    error: 'Authentication required for CRUD operations',
                    solution: 'Please login or register first',
                    authToken: !!authToken,
                    currentUser: !!currentUser,
                    hint: 'Use the registration/login forms or click "Clear Auth" and try again'
                });
                return;
            }

            try {
                // 1. CREATE - POST /blogs/
                const newBlog = {
                    title: 'Test Blog from API Demo',
                    content: '<p>This is a test blog created via API testing. <strong>HTML content works!</strong></p>',
                    domain: 'Testing',
                    writer: 'API Tester',
                    blog_link: 'https://example.com/test-blog'
                };

                console.log('Creating blog with token:', authToken.substring(0, 10) + '...');
                const createResponse = await makeAuthenticatedRequest(`${API_BASE}/blogs/`, {
                    method: 'POST',
                    body: JSON.stringify(newBlog)
                });
                
                let createdBlog;
                try {
                    createdBlog = await createResponse.json();
                } catch {
                    createdBlog = { error: 'Failed to parse response' };
                }
                
                addTestResult('/blogs/', 'POST (CREATE)', createResponse.status, createdBlog);

                if (createResponse.ok && createdBlog.id) {
                    // 2. READ - GET /blogs/{id}/
                    const readResponse = await fetch(`${API_BASE}/blogs/${createdBlog.id}/`);
                    let readBlog;
                    try {
                        readBlog = await readResponse.json();
                    } catch {
                        readBlog = { error: 'Failed to parse response' };
                    }
                    addTestResult(`/blogs/${createdBlog.id}/`, 'GET (READ)', readResponse.status, readBlog);

                    // 3. UPDATE - PUT /blogs/{id}/
                    const updateData = {
                        ...newBlog,
                        title: 'Updated Test Blog from API Demo',
                        content: '<p>This blog has been <em>updated</em> via API testing!</p>'
                    };
                    const updateResponse = await makeAuthenticatedRequest(`${API_BASE}/blogs/${createdBlog.id}/`, {
                        method: 'PUT',
                        body: JSON.stringify(updateData)
                    });
                    
                    let updatedBlog;
                    try {
                        updatedBlog = await updateResponse.json();
                    } catch {
                        updatedBlog = { error: 'Failed to parse response' };
                    }
                    addTestResult(`/blogs/${createdBlog.id}/`, 'PUT (UPDATE)', updateResponse.status, updatedBlog);

                    // 4. DELETE - DELETE /blogs/{id}/
                    const deleteResponse = await makeAuthenticatedRequest(`${API_BASE}/blogs/${createdBlog.id}/`, {
                        method: 'DELETE'
                    });
                    
                    let deleteResult;
                    if (deleteResponse.status === 204) {
                        deleteResult = { message: 'Blog deleted successfully (204 No Content)' };
                    } else {
                        try {
                            deleteResult = await deleteResponse.json();
                        } catch {
                            deleteResult = { message: 'Delete response received but no JSON body' };
                        }
                    }
                    addTestResult(`/blogs/${createdBlog.id}/`, 'DELETE', deleteResponse.status, deleteResult);

                    // Refresh blog list after CRUD operations
                    await loadBlogs();
                    showStatus('🧪 Blog CRUD test completed! Check the test results above.', 'success');
                } else {
                    addTestResult('Blog CRUD', 'INCOMPLETE', 'ERROR', { 
                        error: 'Failed to create blog for testing',
                        createResponse: createdBlog,
                        authToken: !!authToken
                    });
                }

            } catch (error) {
                addTestResult('Blog CRUD', 'MULTIPLE', 'ERROR', { 
                    error: error.message,
                    stack: error.stack
                });
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            // Try to load existing authentication state
            const hasAuth = loadAuthState();
            
            if (hasAuth) {
                // Auto-populate user info if authenticated
                document.getElementById('displayUsername').textContent = currentUser.username;
                document.getElementById('displayEmail').textContent = currentUser.email;
                document.getElementById('displayCanImport').textContent = currentUser.can_import_rss ? 'Yes' : 'No';
                document.getElementById('displayToken').textContent = authToken.substring(0, 20) + '...';
                
                // Show authenticated sections
                document.getElementById('registrationSection').classList.add('hidden');
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('rssSection').classList.remove('hidden');
                
                showStatus('� Restored previous authentication session. You can continue testing APIs!', 'success');
                
                // Auto-load blogs if user is authenticated
                loadBlogs();
                loadDomainStats();
            } else {
                showStatus('�🚀 Welcome! Register a new user or login with existing credentials to start the demo.', 'info');
            }
        });
    </script>
</body>
</html>
